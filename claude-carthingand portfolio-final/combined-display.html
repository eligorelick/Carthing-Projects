<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Car Thing Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: sans-serif; background: #0a0a0a; color: #e8e8e8; width: 800px; height: 480px; overflow: hidden; padding-right: 40px; }
        .container { display: flex; flex-direction: column; height: 100%; }
        .tabs { display: flex; background: #141414; border-bottom: 1px solid #2a2a2a; }
        .tab { flex: 1; padding: 15px; text-align: center; font-size: 19px; color: #888; cursor: pointer; }
        .tab.active { color: #3b82f6; border-bottom: 2px solid #3b82f6; }
        .content { flex: 1; padding: 20px; overflow: hidden; }
        .mode { display: none; height: 100%; }
        .mode.active { display: flex; flex-direction: column; height: 100%; }
        .card { background: #141414; border: 1px solid #2a2a2a; border-radius: 10px; padding: 18px; margin-bottom: 12px; }
        .card-title { font-size: 17px; color: #888; margin-bottom: 10px; }
        .card-value { font-size: 38px; font-weight: bold; }
        .progress { height: 8px; background: #2a2a2a; border-radius: 4px; margin-top: 8px; }
        .progress-fill { height: 100%; border-radius: 4px; }
        .green { background: #22c55e; color: #22c55e; }
        .orange { background: #f97316; color: #f97316; }
        .red { background: #ef4444; color: #ef4444; }
        .cards-row { display: flex; gap: 15px; }
        .cards-row .card { flex: 1; }
        .row { display: grid; grid-template-columns: 90px 1fr 1fr 1fr; gap: 10px; padding: 12px 0; border-bottom: 1px solid #2a2a2a; font-size: 17px; }
        .row.header { color: #888; font-size: 14px; }
        .symbol { color: #3b82f6; font-weight: bold; }
        .shares { font-size: 12px; color: #888; }
        .right { text-align: right; }
        .pos { color: #22c55e; }
        .neg { color: #ef4444; }
        .footer { padding: 10px 20px; background: #141414; border-top: 1px solid #2a2a2a; display: flex; justify-content: space-between; font-size: 12px; color: #888; }
        .debug { position: fixed; top: 5px; right: 5px; background: #333; padding: 5px 10px; font-size: 11px; border-radius: 4px; z-index: 100; }
        .error { color: #ef4444; padding: 20px; text-align: center; }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-shrink: 0; }
        .total { font-size: 29px; font-weight: bold; }
        .change { font-size: 19px; }
        .dots { display: flex; justify-content: center; gap: 8px; padding: 8px 0; flex-shrink: 0; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #2a2a2a; }
        .dot.active { background: #3b82f6; }
        .portfolio-page { display: none; flex: 1; overflow: hidden; }
        .portfolio-page.active { display: flex; flex-direction: column; }
        .holdings-list { flex: 1; overflow-y: auto; }
        .chart-container { flex: 1; position: relative; }
        .chart-header { text-align: center; padding: 10px 0; }
        .chart-header .val { font-size: 34px; font-weight: bold; }
        .chart-header .pct { font-size: 19px; }
        /* 2048 Game Styles */
        .game-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .game-header { display: flex; justify-content: space-between; align-items: center; width: 340px; margin-bottom: 10px; }
        .game-title { font-size: 28px; font-weight: bold; color: #f59563; }
        .game-scores { display: flex; gap: 10px; }
        .score-box { background: #141414; border: 1px solid #2a2a2a; border-radius: 6px; padding: 8px 12px; text-align: center; min-width: 70px; }
        .score-label { font-size: 11px; color: #888; text-transform: uppercase; }
        .score-value { font-size: 20px; font-weight: bold; color: #e8e8e8; }
        .game-board { background: #1a1a1a; border-radius: 8px; padding: 8px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; touch-action: none; }
        .tile { width: 78px; height: 78px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: bold; background: #2a2a2a; color: #888; transition: all 0.1s ease; }
        .tile-2 { background: #3d3d3d; color: #e8e8e8; }
        .tile-4 { background: #4a4a4a; color: #e8e8e8; }
        .tile-8 { background: #f2b179; color: #1a1a1a; }
        .tile-16 { background: #f59563; color: #1a1a1a; }
        .tile-32 { background: #f67c5f; color: #fff; }
        .tile-64 { background: #f65e3b; color: #fff; }
        .tile-128 { background: #edcf72; color: #1a1a1a; font-size: 24px; }
        .tile-256 { background: #edcc61; color: #1a1a1a; font-size: 24px; }
        .tile-512 { background: #edc850; color: #1a1a1a; font-size: 24px; }
        .tile-1024 { background: #edc53f; color: #1a1a1a; font-size: 20px; }
        .tile-2048 { background: #edc22e; color: #1a1a1a; font-size: 20px; }
        .tile-super { background: #3c3a32; color: #f9f6f2; font-size: 18px; }
        .game-over { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); padding: 20px 40px; border-radius: 10px; text-align: center; z-index: 10; }
        .game-over-text { font-size: 24px; font-weight: bold; color: #f59563; margin-bottom: 10px; }
        .new-game-btn { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-size: 16px; cursor: pointer; }
        /* Theme toggle button */
        .theme-btn { background: #2a2a2a; border: 1px solid #3a3a3a; color: #888; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; margin-right: 15px; }
        /* Light mode styles */
        body.light { background: #f5f5f5; color: #1a1a1a; }
        body.light .container { background: #f5f5f5; }
        body.light .tabs { background: #e8e8e8; border-color: #ccc; }
        body.light .tab { color: #666; }
        body.light .tab.active { color: #3b82f6; }
        body.light .content { background: #f5f5f5; }
        body.light .card { background: #fff; border-color: #ddd; }
        body.light .card-title { color: #666; }
        body.light .progress { background: #ddd; }
        body.light .row { border-color: #ddd; }
        body.light .row.header { color: #666; }
        body.light .shares { color: #666; }
        body.light .footer { background: #e8e8e8; border-color: #ccc; color: #666; }
        body.light .debug { background: #ddd; color: #333; }
        body.light .dot { background: #ccc; }
        body.light .header-row { color: #1a1a1a; }
        body.light .game-board { background: #cdc1b4; }
        body.light .tile { background: #eee4da; color: #776e65; }
        body.light .score-box { background: #fff; border-color: #ddd; }
        body.light .score-label { color: #666; }
        body.light .score-value { color: #1a1a1a; }
        body.light .theme-btn { background: #ddd; border-color: #ccc; color: #333; }
    </style>
</head>
<body>
    <div class="container">
        <div class="tabs">
            <div class="tab active" id="tab1" onclick="setMode(0)">Claude [1]</div>
            <div class="tab" id="tab2" onclick="setMode(1)">Portfolio [2/3]</div>
            <div class="tab" id="tab3" onclick="setMode(2)">2048 [4]</div>
        </div>
        <div class="content">
            <div class="mode active" id="mode0">
                <div id="claudeContent">Loading Claude data...</div>
            </div>
            <div class="mode" id="mode1">
                <div class="header-row">
                    <div class="total" id="totalValue">--</div>
                    <div class="change" id="dayChange">--</div>
                </div>
                <div class="dots">
                    <div class="dot active" id="dot0"></div>
                    <div class="dot" id="dot1"></div>
                </div>
                <div class="portfolio-page active" id="page0">
                    <div class="holdings-list" id="holdingsList">Loading...</div>
                </div>
                <div class="portfolio-page" id="page1">
                    <div class="chart-header">
                        <div class="val" id="chartGain">--</div>
                        <div class="pct" id="chartPct">--</div>
                    </div>
                    <div class="chart-container">
                        <canvas id="dayChart" width="700" height="250"></canvas>
                    </div>
                </div>
            </div>
            <div class="mode" id="mode2">
                <div class="game-container">
                    <div class="game-header">
                        <div class="game-title">2048</div>
                        <div class="game-scores">
                            <div class="score-box">
                                <div class="score-label">Score</div>
                                <div class="score-value" id="gameScore">0</div>
                            </div>
                            <div class="score-box">
                                <div class="score-label">Best</div>
                                <div class="score-value" id="bestScore">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="game-board" id="gameBoard"></div>
                </div>
            </div>
        </div>
        <div class="footer">
            <div style="display:flex;align-items:center;"><button class="theme-btn" id="themeBtn" onclick="toggleTheme()">Light</button><span id="status">Starting...</span></div>
            <div id="clock">--:--:--</div>
            <div id="update">--</div>
        </div>
    </div>
    <div class="debug" id="debug">Ready</div>

    <script>
        var SERVER = 'http://172.16.42.1:8080';
        var currentMode = 0;
        var currentPage = 0;
        var chartData = null;
        var gameInitialized = false;
        var isLightMode = localStorage.getItem('theme') === 'light';

        // Theme toggle
        function toggleTheme() {
            isLightMode = !isLightMode;
            document.body.className = isLightMode ? 'light' : '';
            document.getElementById('themeBtn').textContent = isLightMode ? 'Dark' : 'Light';
            localStorage.setItem('theme', isLightMode ? 'light' : 'dark');
            // Redraw chart with correct colors
            if (chartData && currentMode === 1 && currentPage === 1) {
                renderChart(chartData);
            }
        }

        // Apply saved theme on load
        if (isLightMode) {
            document.body.className = 'light';
            document.getElementById('themeBtn').textContent = 'Dark';
        }

        // Prevent screen dimming - keep activity going
        function preventDimming() {
            // Simulate activity to prevent auto-dim
            var hidden = document.createElement('div');
            hidden.style.cssText = 'position:fixed;top:-1px;left:-1px;width:1px;height:1px;opacity:0.01;';
            document.body.appendChild(hidden);
            setInterval(function() {
                hidden.style.opacity = hidden.style.opacity === '0.01' ? '0.02' : '0.01';
            }, 30000);

            // Request wake lock if available (modern browsers)
            if ('wakeLock' in navigator) {
                navigator.wakeLock.request('screen').catch(function() {});
            }

            // Prevent visibility change sleep
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'visible' && 'wakeLock' in navigator) {
                    navigator.wakeLock.request('screen').catch(function() {});
                }
            });
        }
        preventDimming();

        function log(msg) {
            document.getElementById('debug').textContent = msg;
            document.getElementById('status').textContent = msg;
        }

        function setMode(m) {
            currentMode = m;
            document.getElementById('tab1').className = m === 0 ? 'tab active' : 'tab';
            document.getElementById('tab2').className = m === 1 ? 'tab active' : 'tab';
            document.getElementById('tab3').className = m === 2 ? 'tab active' : 'tab';
            document.getElementById('mode0').className = m === 0 ? 'mode active' : 'mode';
            document.getElementById('mode1').className = m === 1 ? 'mode active' : 'mode';
            document.getElementById('mode2').className = m === 2 ? 'mode active' : 'mode';
            var modeNames = ['Claude', 'Portfolio', '2048'];
            log('Mode: ' + modeNames[m]);
            if (m === 2 && !gameInitialized) {
                initGame();
                gameInitialized = true;
            }
        }

        function setPage(p) {
            currentPage = p;
            document.getElementById('page0').className = p === 0 ? 'portfolio-page active' : 'portfolio-page';
            document.getElementById('page1').className = p === 1 ? 'portfolio-page active' : 'portfolio-page';
            document.getElementById('dot0').className = p === 0 ? 'dot active' : 'dot';
            document.getElementById('dot1').className = p === 1 ? 'dot active' : 'dot';
            log('Page: ' + (p === 0 ? 'Holdings' : 'Chart'));
            if (p === 1 && chartData) {
                renderChart(chartData);
            }
        }

        document.addEventListener('keydown', function(e) {
            log('Key: ' + e.key);
            if (e.key === '1') setMode(0);
            if (e.key === '2') { setMode(1); setPage(0); }
            if (e.key === '3') { setMode(1); setPage(1); }
            if (e.key === '4') setMode(2);
            // Arrow keys for 2048 when in game mode
            if (currentMode === 2) {
                if (e.key === 'ArrowUp') { move('up'); e.preventDefault(); }
                if (e.key === 'ArrowDown') { move('down'); e.preventDefault(); }
                if (e.key === 'ArrowLeft') { move('left'); e.preventDefault(); }
                if (e.key === 'ArrowRight') { move('right'); e.preventDefault(); }
            }
        });

        var wheelAcc = 0;
        document.addEventListener('wheel', function(e) {
            var delta = e.deltaX !== 0 ? e.deltaX : e.deltaY;
            wheelAcc += delta;
            if (Math.abs(wheelAcc) > 80) {
                if (currentMode === 1 && currentPage === 0) {
                    var list = document.getElementById('holdingsList');
                    list.scrollTop += (wheelAcc > 0 ? 60 : -60);
                }
                wheelAcc = 0;
            }
        });

        function updateClock() {
            document.getElementById('clock').textContent = new Date().toLocaleTimeString();
        }
        setInterval(updateClock, 1000);
        updateClock();

        function fetchClaude() {
            log('Fetching Claude...');
            var xhr = new XMLHttpRequest();
            xhr.open('GET', SERVER + '/claude', true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        log('Claude OK');
                        var data = JSON.parse(xhr.responseText);
                        renderClaude(data);
                    } else {
                        log('Claude Error: ' + xhr.status);
                        document.getElementById('claudeContent').innerHTML = '<div class="error">Error: ' + xhr.status + '</div>';
                    }
                }
            };
            xhr.onerror = function() {
                log('Claude XHR Error');
                document.getElementById('claudeContent').innerHTML = '<div class="error">Connection failed</div>';
            };
            xhr.send();
        }

        function renderClaude(data) {
            var html = '<div class="cards-row">';
            if (data.five_hour) {
                var p = data.five_hour.utilization || 0;
                var c = p < 50 ? 'green' : (p < 80 ? 'orange' : 'red');
                html += '<div class="card"><div class="card-title">5-Hour</div><div class="card-value">' + p.toFixed(1) + '%</div><div class="progress"><div class="progress-fill ' + c + '" style="width:' + p + '%"></div></div></div>';
            }
            if (data.seven_day) {
                var p = data.seven_day.utilization || 0;
                var c = p < 50 ? 'green' : (p < 80 ? 'orange' : 'red');
                html += '<div class="card"><div class="card-title">7-Day</div><div class="card-value">' + p.toFixed(1) + '%</div><div class="progress"><div class="progress-fill ' + c + '" style="width:' + p + '%"></div></div></div>';
            }
            if (data.seven_day_sonnet) {
                var p = data.seven_day_sonnet.utilization || 0;
                var c = p < 50 ? 'green' : (p < 80 ? 'orange' : 'red');
                html += '<div class="card"><div class="card-title">Sonnet</div><div class="card-value">' + p.toFixed(1) + '%</div><div class="progress"><div class="progress-fill ' + c + '" style="width:' + p + '%"></div></div></div>';
            }
            html += '</div>';
            document.getElementById('claudeContent').innerHTML = html || '<div class="error">No data</div>';
        }

        function fetchPortfolio() {
            log('Fetching Portfolio...');
            var xhr = new XMLHttpRequest();
            xhr.open('GET', SERVER + '/portfolio', true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        log('Portfolio OK');
                        var data = JSON.parse(xhr.responseText);
                        renderPortfolio(data);
                        document.getElementById('update').textContent = data.last_update || '--';
                    } else {
                        log('Portfolio Error: ' + xhr.status);
                    }
                }
            };
            xhr.send();

            var xhr2 = new XMLHttpRequest();
            xhr2.open('GET', SERVER + '/chart', true);
            xhr2.onreadystatechange = function() {
                if (xhr2.readyState === 4 && xhr2.status === 200) {
                    chartData = JSON.parse(xhr2.responseText);
                    if (currentPage === 1) renderChart(chartData);
                }
            };
            xhr2.send();
        }

        function renderPortfolio(data) {
            var sign = data.total_day_gain_dollars >= 0 ? '+' : '';
            var cls = data.total_day_gain_dollars >= 0 ? 'pos' : 'neg';
            document.getElementById('totalValue').textContent = '$' + data.total_market_value.toLocaleString();
            document.getElementById('dayChange').className = 'change ' + cls;
            document.getElementById('dayChange').textContent = sign + '$' + data.total_day_gain_dollars.toFixed(2) + ' (' + sign + data.total_day_gain_percent.toFixed(2) + '%)';

            var html = '<div class="row header"><div>Symbol</div><div class="right">Value</div><div class="right">Day</div><div class="right">Total</div></div>';
            for (var i = 0; i < data.positions.length; i++) {
                var p = data.positions[i];
                var dc = p.day_gain_dollars >= 0 ? 'pos' : 'neg';
                var tc = p.total_gain_dollars >= 0 ? 'pos' : 'neg';
                var ds = p.day_gain_dollars >= 0 ? '+' : '';
                var ts = p.total_gain_dollars >= 0 ? '+' : '';
                var dayDollar = Math.abs(p.day_gain_dollars) >= 1000 ? (p.day_gain_dollars/1000).toFixed(1) + 'k' : p.day_gain_dollars.toFixed(0);
                var totalDollar = Math.abs(p.total_gain_dollars) >= 1000 ? (p.total_gain_dollars/1000).toFixed(1) + 'k' : p.total_gain_dollars.toFixed(0);
                html += '<div class="row"><div><div class="symbol">' + p.symbol + '</div><div class="shares">' + p.shares + '@$' + p.cost_per_share + '</div></div><div class="right">$' + (p.market_value/1000).toFixed(1) + 'k</div><div class="right ' + dc + '">' + ds + p.day_gain_percent.toFixed(1) + '%<br>' + ds + '$' + dayDollar + '</div><div class="right ' + tc + '">' + ts + p.total_gain_percent.toFixed(1) + '%<br>' + ts + '$' + totalDollar + '</div></div>';
            }
            html += '<div class="row" style="border-top:2px solid #2a2a2a;margin-top:5px;padding-top:10px;"><div><div class="symbol">SWVXX</div><div class="shares">Money Mkt</div></div><div class="right">$' + (data.money_market/1000).toFixed(1) + 'k</div><div class="right">--</div><div class="right">--</div></div>';
            html += '<div class="row"><div class="symbol">Cash</div><div class="right">$' + (data.cash/1000).toFixed(1) + 'k</div><div class="right">--</div><div class="right">--</div></div>';
            document.getElementById('holdingsList').innerHTML = html;
        }

        // Chart state for touch interaction
        var chartState = {
            values: [],
            labels: [],
            minVal: 0,
            maxVal: 0,
            range: 0,
            prevClose: 0,
            padding: 50,
            color: '#22c55e',
            fillColor: 'rgba(34,197,94,0.15)',
            scrubIndex: -1
        };

        function renderChart(data) {
            if (!data || !data.points || data.points.length === 0) {
                log('No chart data');
                return;
            }
            chartState.values = [];
            chartState.labels = [];
            for (var i = 0; i < data.points.length; i++) {
                chartState.values.push(data.points[i].value);
                chartState.labels.push(data.points[i].time);
            }
            chartState.prevClose = data.previous_close;
            var curr = chartState.values[chartState.values.length - 1];
            var gain = curr - chartState.prevClose;
            var pct = ((curr - chartState.prevClose) / chartState.prevClose) * 100;

            document.getElementById('chartGain').className = 'val ' + (gain >= 0 ? 'pos' : 'neg');
            document.getElementById('chartGain').textContent = (gain >= 0 ? '+' : '') + '$' + gain.toFixed(2);
            document.getElementById('chartPct').className = 'pct ' + (gain >= 0 ? 'pos' : 'neg');
            document.getElementById('chartPct').textContent = (gain >= 0 ? '+' : '') + pct.toFixed(2) + '%';

            // Find min/max for scaling
            chartState.minVal = Math.min.apply(null, chartState.values);
            chartState.maxVal = Math.max.apply(null, chartState.values);
            chartState.range = chartState.maxVal - chartState.minVal || 1;
            chartState.minVal -= chartState.range * 0.1;
            chartState.maxVal += chartState.range * 0.1;
            chartState.range = chartState.maxVal - chartState.minVal;

            chartState.color = gain >= 0 ? '#22c55e' : '#ef4444';
            chartState.fillColor = gain >= 0 ? 'rgba(34,197,94,0.15)' : 'rgba(239,68,68,0.15)';
            chartState.scrubIndex = -1;

            drawChart();
            setupChartTouch();
            log('Chart rendered');
        }

        // Timezone helpers - convert market hours (EST) to user's local time
        function getTimezoneOffset() {
            // Get offset from EST (UTC-5) in hours
            var userOffsetMin = new Date().getTimezoneOffset();
            var estOffsetMin = 300; // EST is UTC-5 = 300 minutes
            return (estOffsetMin - userOffsetMin) / 60;
        }

        function formatTime(hour, min) {
            var ampm = hour >= 12 ? 'p' : 'a';
            var h = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
            return h + ':' + (min < 10 ? '0' : '') + min + ampm;
        }

        function getLocalMarketTimeLabels() {
            // Market hours: 9:30 AM - 4:00 PM EST
            var offset = getTimezoneOffset();
            var labels = [];
            var estTimes = [
                {h: 9, m: 30}, {h: 11, m: 0}, {h: 12, m: 30},
                {h: 14, m: 0}, {h: 15, m: 30}, {h: 16, m: 0}
            ];
            for (var i = 0; i < estTimes.length; i++) {
                var localH = estTimes[i].h + offset;
                if (localH < 0) localH += 24;
                if (localH >= 24) localH -= 24;
                labels.push(formatTime(localH, estTimes[i].m));
            }
            return labels;
        }

        function getLocalTimeForIndex(idx, total) {
            // Market is 9:30 AM - 4:00 PM EST = 6.5 hours = 390 min
            var offset = getTimezoneOffset();
            var minFromStart = (idx / (total - 1)) * 390;
            var estH = 9 + Math.floor((30 + minFromStart) / 60);
            var estM = Math.floor((30 + minFromStart) % 60);
            var localH = estH + offset;
            if (localH < 0) localH += 24;
            if (localH >= 24) localH -= 24;
            return formatTime(localH, estM);
        }

        function drawChart(scrubIdx) {
            var canvas = document.getElementById('dayChart');
            var ctx = canvas.getContext('2d');
            var w = canvas.width;
            var h = canvas.height;
            var padding = chartState.padding;
            var values = chartState.values;
            var labels = chartState.labels;

            // Clear canvas
            ctx.fillStyle = isLightMode ? '#f5f5f5' : '#0a0a0a';
            ctx.fillRect(0, 0, w, h);

            // Draw grid lines
            ctx.strokeStyle = isLightMode ? '#ddd' : '#2a2a2a';
            ctx.lineWidth = 1;
            for (var i = 0; i <= 4; i++) {
                var y = padding + (h - padding * 2) * i / 4;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(w - padding, y);
                ctx.stroke();
            }

            // Draw Y axis labels
            ctx.fillStyle = isLightMode ? '#666' : '#888';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'right';
            for (var i = 0; i <= 4; i++) {
                var y = padding + (h - padding * 2) * i / 4;
                var val = chartState.maxVal - (chartState.range * i / 4);
                ctx.fillText('$' + (val/1000).toFixed(0) + 'k', padding - 8, y + 4);
            }

            // Draw filled area
            ctx.beginPath();
            ctx.moveTo(padding, h - padding);
            for (var i = 0; i < values.length; i++) {
                var x = padding + (w - padding * 2) * i / (values.length - 1);
                var y = padding + (h - padding * 2) * (1 - (values[i] - chartState.minVal) / chartState.range);
                ctx.lineTo(x, y);
            }
            ctx.lineTo(w - padding, h - padding);
            ctx.closePath();
            ctx.fillStyle = chartState.fillColor;
            ctx.fill();

            // Draw line
            ctx.beginPath();
            for (var i = 0; i < values.length; i++) {
                var x = padding + (w - padding * 2) * i / (values.length - 1);
                var y = padding + (h - padding * 2) * (1 - (values[i] - chartState.minVal) / chartState.range);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.strokeStyle = chartState.color;
            ctx.lineWidth = 2;
            ctx.stroke();

            // Draw X axis labels - market hours in user's local timezone
            ctx.fillStyle = isLightMode ? '#666' : '#888';
            ctx.textAlign = 'center';
            var timeLabels = getLocalMarketTimeLabels();
            for (var i = 0; i < timeLabels.length; i++) {
                var x = padding + (w - padding * 2) * i / (timeLabels.length - 1);
                ctx.fillText(timeLabels[i], x, h - padding + 20);
            }

            // Draw scrub indicator if active
            if (typeof scrubIdx === 'number' && scrubIdx >= 0 && scrubIdx < values.length) {
                var scrubX = padding + (w - padding * 2) * scrubIdx / (values.length - 1);
                var scrubY = padding + (h - padding * 2) * (1 - (values[scrubIdx] - chartState.minVal) / chartState.range);
                var scrubVal = values[scrubIdx];
                var scrubGain = scrubVal - chartState.prevClose;
                var scrubPct = ((scrubVal - chartState.prevClose) / chartState.prevClose) * 100;

                // Vertical line
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1;
                ctx.setLineDash([4, 4]);
                ctx.beginPath();
                ctx.moveTo(scrubX, padding);
                ctx.lineTo(scrubX, h - padding);
                ctx.stroke();
                ctx.setLineDash([]);

                // Dot on line
                ctx.beginPath();
                ctx.arc(scrubX, scrubY, 6, 0, Math.PI * 2);
                ctx.fillStyle = chartState.color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Value tooltip
                var tooltipText = '$' + (scrubVal/1000).toFixed(1) + 'k';
                var gainText = (scrubGain >= 0 ? '+' : '') + '$' + scrubGain.toFixed(0) + ' (' + (scrubGain >= 0 ? '+' : '') + scrubPct.toFixed(1) + '%)';

                // Calculate time for this index in user's local timezone
                var timeText = getLocalTimeForIndex(scrubIdx, values.length);

                ctx.font = 'bold 14px sans-serif';
                ctx.fillStyle = isLightMode ? '#1a1a1a' : '#fff';
                ctx.textAlign = 'center';
                ctx.fillText(tooltipText, scrubX, scrubY - 35);
                ctx.font = '12px sans-serif';
                ctx.fillStyle = scrubGain >= 0 ? '#22c55e' : '#ef4444';
                ctx.fillText(gainText, scrubX, scrubY - 20);
                ctx.fillStyle = isLightMode ? '#666' : '#888';
                ctx.fillText(timeText, scrubX, h - padding + 35);
            }
        }

        var chartTouchSetup = false;
        function setupChartTouch() {
            if (chartTouchSetup) return;
            chartTouchSetup = true;
            var canvas = document.getElementById('dayChart');
            var padding = chartState.padding;

            function handleTouch(e) {
                if (currentMode !== 1 || currentPage !== 1) return;
                var rect = canvas.getBoundingClientRect();
                var x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                var scaleX = canvas.width / rect.width;
                x *= scaleX;

                // Clamp to chart area
                var chartWidth = canvas.width - padding * 2;
                x = Math.max(padding, Math.min(canvas.width - padding, x));
                var ratio = (x - padding) / chartWidth;
                var idx = Math.round(ratio * (chartState.values.length - 1));
                idx = Math.max(0, Math.min(chartState.values.length - 1, idx));

                chartState.scrubIndex = idx;
                drawChart(idx);
                e.preventDefault();
            }

            function handleEnd() {
                chartState.scrubIndex = -1;
                drawChart();
            }

            canvas.addEventListener('touchstart', handleTouch, {passive: false});
            canvas.addEventListener('touchmove', handleTouch, {passive: false});
            canvas.addEventListener('touchend', handleEnd, {passive: false});
            canvas.addEventListener('mousedown', handleTouch);
            canvas.addEventListener('mousemove', function(e) { if (e.buttons) handleTouch(e); });
            canvas.addEventListener('mouseup', handleEnd);
            canvas.addEventListener('mouseleave', handleEnd);
        }

        log('Init...');
        fetchClaude();
        fetchPortfolio();
        setInterval(fetchClaude, 600000);
        setInterval(fetchPortfolio, 600000);

        // 2048 Game Logic
        var grid = [];
        var score = 0;
        var bestScore = parseInt(localStorage.getItem('2048best') || '0');
        var gameOver = false;
        var touchStartX = 0;
        var touchStartY = 0;

        function initGame() {
            grid = [[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]];
            score = 0;
            gameOver = false;
            addRandomTile();
            addRandomTile();
            renderBoard();
            updateScores();
            setupTouchControls();
        }

        function addRandomTile() {
            var empty = [];
            for (var i = 0; i < 4; i++) {
                for (var j = 0; j < 4; j++) {
                    if (grid[i][j] === 0) empty.push({r: i, c: j});
                }
            }
            if (empty.length > 0) {
                var cell = empty[Math.floor(Math.random() * empty.length)];
                grid[cell.r][cell.c] = Math.random() < 0.9 ? 2 : 4;
            }
        }

        function renderBoard() {
            var html = '';
            for (var i = 0; i < 4; i++) {
                for (var j = 0; j < 4; j++) {
                    var val = grid[i][j];
                    var cls = 'tile';
                    if (val > 0) {
                        cls += ' tile-' + (val <= 2048 ? val : 'super');
                    }
                    html += '<div class="' + cls + '">' + (val > 0 ? val : '') + '</div>';
                }
            }
            document.getElementById('gameBoard').innerHTML = html;
        }

        function updateScores() {
            document.getElementById('gameScore').textContent = score;
            if (score > bestScore) {
                bestScore = score;
                localStorage.setItem('2048best', bestScore);
            }
            document.getElementById('bestScore').textContent = bestScore;
        }

        function move(dir) {
            if (gameOver) return;
            var moved = false;
            var newGrid = JSON.parse(JSON.stringify(grid));

            if (dir === 'left') {
                for (var i = 0; i < 4; i++) {
                    var row = newGrid[i].filter(function(v) { return v !== 0; });
                    for (var j = 0; j < row.length - 1; j++) {
                        if (row[j] === row[j+1]) {
                            row[j] *= 2;
                            score += row[j];
                            row.splice(j+1, 1);
                        }
                    }
                    while (row.length < 4) row.push(0);
                    newGrid[i] = row;
                }
            } else if (dir === 'right') {
                for (var i = 0; i < 4; i++) {
                    var row = newGrid[i].filter(function(v) { return v !== 0; });
                    for (var j = row.length - 1; j > 0; j--) {
                        if (row[j] === row[j-1]) {
                            row[j] *= 2;
                            score += row[j];
                            row.splice(j-1, 1);
                            j--;
                        }
                    }
                    while (row.length < 4) row.unshift(0);
                    newGrid[i] = row;
                }
            } else if (dir === 'up') {
                for (var j = 0; j < 4; j++) {
                    var col = [];
                    for (var i = 0; i < 4; i++) col.push(newGrid[i][j]);
                    col = col.filter(function(v) { return v !== 0; });
                    for (var i = 0; i < col.length - 1; i++) {
                        if (col[i] === col[i+1]) {
                            col[i] *= 2;
                            score += col[i];
                            col.splice(i+1, 1);
                        }
                    }
                    while (col.length < 4) col.push(0);
                    for (var i = 0; i < 4; i++) newGrid[i][j] = col[i];
                }
            } else if (dir === 'down') {
                for (var j = 0; j < 4; j++) {
                    var col = [];
                    for (var i = 0; i < 4; i++) col.push(newGrid[i][j]);
                    col = col.filter(function(v) { return v !== 0; });
                    for (var i = col.length - 1; i > 0; i--) {
                        if (col[i] === col[i-1]) {
                            col[i] *= 2;
                            score += col[i];
                            col.splice(i-1, 1);
                            i--;
                        }
                    }
                    while (col.length < 4) col.unshift(0);
                    for (var i = 0; i < 4; i++) newGrid[i][j] = col[i];
                }
            }

            // Check if board changed
            for (var i = 0; i < 4; i++) {
                for (var j = 0; j < 4; j++) {
                    if (grid[i][j] !== newGrid[i][j]) moved = true;
                }
            }

            if (moved) {
                grid = newGrid;
                addRandomTile();
                renderBoard();
                updateScores();
                checkGameOver();
            }
        }

        function checkGameOver() {
            // Check for empty cells
            for (var i = 0; i < 4; i++) {
                for (var j = 0; j < 4; j++) {
                    if (grid[i][j] === 0) return;
                }
            }
            // Check for possible merges
            for (var i = 0; i < 4; i++) {
                for (var j = 0; j < 4; j++) {
                    if (j < 3 && grid[i][j] === grid[i][j+1]) return;
                    if (i < 3 && grid[i][j] === grid[i+1][j]) return;
                }
            }
            gameOver = true;
            log('Game Over! Score: ' + score);
        }

        function setupTouchControls() {
            var board = document.getElementById('gameBoard');
            board.addEventListener('touchstart', function(e) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                e.preventDefault();
            }, {passive: false});

            board.addEventListener('touchend', function(e) {
                if (currentMode !== 2) return;
                var dx = e.changedTouches[0].clientX - touchStartX;
                var dy = e.changedTouches[0].clientY - touchStartY;
                var minSwipe = 30;

                if (Math.abs(dx) > Math.abs(dy)) {
                    if (Math.abs(dx) > minSwipe) {
                        move(dx > 0 ? 'right' : 'left');
                    }
                } else {
                    if (Math.abs(dy) > minSwipe) {
                        move(dy > 0 ? 'down' : 'up');
                    }
                }
                e.preventDefault();
            }, {passive: false});
        }

        function newGame() {
            initGame();
        }
    </script>
</body>
</html>